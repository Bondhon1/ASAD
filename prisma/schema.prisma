// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                    String                 @id @default(cuid())
  username              String?                @unique
  fullName              String?
  email                 String                 @unique
  phone                 String?                @unique
  password              String?
  profilePicUrl         String?
  institute             Institute?             @relation(fields: [instituteId], references: [id], onDelete: SetNull)
  instituteId           String?
  joiningSemester       String?
  status                UserStatus             @default(APPLICANT)
  volunteerId           String?                @unique
  designation           String?
  role                  UserRole               @default(VOLUNTEER)
  emailVerified         Boolean                @default(false)
  emailVerificationToken String?               @unique
  emailVerificationExpiry DateTime?
  emailVerificationResendCount Int?            @default(0)
  emailVerificationLastResent  DateTime?

  // Address (Bangladesh)
  division              String?
  district              String?
  upazila               String?
  addressLine           String?
  // Guardian and personal info
  guardianName          String?
  guardianContact       String?
  birthdate             DateTime?
  
  // Google Calendar integration (for HR)
  googleRefreshToken    String?                // Encrypted refresh token
  calendarConnectedAt   DateTime?              // When HR connected Calendar
  calendarEmail         String?                // Which Google account
  
  // Account linking for OAuth
  accounts              Account[]
  sessions              Session[]
  
  // Volunteer specific
  volunteerProfile      VolunteerProfile?
  application           Application?          @relation("Applicant")
  reviewedApplications  Application[]         @relation("ApplicationReviewedBy")
  taskSubmissions       TaskSubmission[]
  donations             Donation[]
  createdTasks          Task[]                 @relation("TaskCreator")
  approvedTaskSubmissions TaskSubmission[]     @relation("ApprovedBy")
  approvedDonations     Donation[]             @relation("ApprovedBy")
  pointsHistory         PointsHistory[]
  experiences           Experience[]
  auditLogs             AuditLog[]             @relation("ActorUser")
  
  // Social features
  posts                 Post[]
  postReactions         PostReaction[]
  commentReactions      CommentReaction[]
  postComments          PostComment[]
  following             Follow[]              @relation("Follower")
  followers             Follow[]              @relation("Following")
  sentMessages          Message[]             @relation("FromUser")
  receivedMessages      Message[]             @relation("ToUser")
  sentFriendRequests    FriendRequest[]       @relation("Sender")
  receivedFriendRequests FriendRequest[]      @relation("Receiver")
  friends               FriendList[]          @relation("User")
  friendOf              FriendList[]          @relation("Friend")
  
  // Committee
  committeeMemberships  CommitteeMember[]
  
  // Payment related
  initialPayment        InitialPayment?      @relation("InitialPaymentOwner")
  finalPayment          FinalPayment?        @relation("FinalPaymentOwner")
  initialPaymentsApproved InitialPayment[]    @relation("InitialPaymentApprovedBy")
  finalPaymentsApproved   FinalPayment[]      @relation("FinalPaymentApprovedBy")
  leaves                Leave[]
  reviewedLeaves        Leave[]          @relation("LeaveReviewedBy")
  
  // Notifications
  notifications         Notification[]
  broadcastReads        BroadcastRead[]
  interviewApprovedById String?
  interviewApprovedBy   User?             @relation("InterviewApprovedBy", fields: [interviewApprovedById], references: [id], onDelete: SetNull)
  interviewApprovedUsers User[]            @relation("InterviewApprovedBy")
  createdServices        Service[]
  
  // APC (Asadian Performance Credit) system
  credits               Int                   @default(0) @map("coins")
  creditWithdrawals     CreditWithdrawal[]    @relation("UserWithdrawals")
  processedWithdrawals  CreditWithdrawal[]    @relation("ProcessedBy")
  orgJoinRequests       OrgJoinRequest[]      @relation("UserOrgJoinRequests")
  processedOrgJoinRequests OrgJoinRequest[]   @relation("ProcessedOrgJoinRequests")
  
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  @@index([email])
  @@index([phone])
  @@index([instituteId])
  @@index([status])
}

enum UserStatus {
  APPLICANT
  INTERVIEW_REQUESTED
  INTERVIEW_SCHEDULED
  INTERVIEW_PASSED
  OFFICIAL
  INACTIVE
  BANNED
  REJECTED
  FINAL_PAYMENT_REJECTED
}

enum UserRole {
  VOLUNTEER
  HR
  MASTER
  ADMIN
  DIRECTOR
  DATABASE_DEPT
  SECRETARIES
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// INSTITUTE & COMMITTEE
// ============================================================================

model Institute {
  id                    String           @id @default(cuid())
  name                  String           @unique
  address               String?
  totalVolunteersCached Int              @default(0)
  committeeCreated      Boolean          @default(false)
  users                 User[]
  services              Service[]
  committee             Committee?
  createdAt             DateTime         @default(now())
  
  @@index([name])
}

model Committee {
  id                    String           @id @default(cuid())
  name                  String
  institute             Institute?       @relation(fields: [instituteId], references: [id], onDelete: SetNull)
  instituteId           String?          @unique
  sector                Sector?          @relation(fields: [sectorId], references: [id], onDelete: SetNull)
  sectorId              String?
  club                  Club?            @relation(fields: [clubId], references: [id], onDelete: SetNull)
  clubId                String?
  department            Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId          String?
  members               CommitteeMember[]
  volunteers            VolunteerProfile[]
  createdAt             DateTime         @default(now())
  
  @@index([instituteId])
  @@index([sectorId])
  @@index([clubId])
  @@index([departmentId])
}

model CommitteeMember {
  id                    String           @id @default(cuid())
  committee             Committee        @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  committeeId           String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  role                  String
  joinedAt              DateTime         @default(now())
  
  @@unique([committeeId, userId])
}

// ============================================================================
// APPLICATION & RECRUITMENT
// ============================================================================

model Application {
  id                    String           @id @default(cuid())
  user                  User             @relation("Applicant", fields: [userId], references: [id], onDelete: Cascade)
  userId                String           @unique
  trxId                 String
  paymentMethod         String           // bkash, nagad, visa, mastercard
  paymentScreenshotUrl  String?
  status                ApplicationStatus @default(PENDING)
  interviewDate         DateTime?
  interviewResult       InterviewResult?
  interviewSlot         InterviewSlot?   @relation(fields: [interviewSlotId], references: [id], onDelete: SetNull)
  interviewSlotId       String?
  reviewedById          String?
  reviewedBy            User?            @relation("ApplicationReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  appliedAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([status])
  @@index([interviewDate])
  @@index([interviewSlotId])
}

enum ApplicationStatus {
  PENDING
  INTERVIEW_REQUESTED
  INTERVIEW_SCHEDULED
  ACCEPTED
  REJECTED
}

enum InterviewResult {
  PASSED
  FAILED
}

// ============================================================================
// VOLUNTEER PROFILE & RANKING
// ============================================================================

model VolunteerProfile {
  userId                String           @unique
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinDate              DateTime         @default(now())
  points                Int              @default(0)
  rank                  Rank?            @relation(fields: [rankId], references: [id])
  rankId                String?
  bio                   String?
  serviceId             String?
  service               Service?         @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  sectors               String[]         // JSON array of sector IDs
  clubs                 String[]         // JSON array of club IDs
  committee             Committee?       @relation(fields: [committeeId], references: [id], onDelete: SetNull)
  committeeId           String?
  isOfficial            Boolean          @default(false)
  
  @@id([userId])
  @@index([rankId])
  @@index([committeeId])
  @@index([isOfficial])
}

model Rank {
  id                    String           @id @default(cuid())
  name                  String           @unique
  thresholdPoints       Int
  description           String?
  parentId              String?
  parent                Rank?            @relation("RankHierarchy", fields: [parentId], references: [id])
  subRanks              Rank[]           @relation("RankHierarchy")
  volunteerProfiles     VolunteerProfile[]
  createdAt             DateTime         @default(now())
  
  @@index([thresholdPoints])
}

model PointsHistory {
  id                    String           @id @default(cuid())
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  change                Int
  reason                String
  relatedTask           Task?            @relation(fields: [relatedTaskId], references: [id], onDelete: SetNull)
  relatedTaskId         String?
  relatedDonation       Donation?        @relation(fields: [relatedDonationId], references: [id], onDelete: SetNull)
  relatedDonationId     String?
  createdAt             DateTime         @default(now())
  
  @@index([userId])
  @@index([relatedTaskId])
  @@index([relatedDonationId])
}

// Volunteer experiences (roles & work history)
model Experience {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  title        String
  organization String?
  startDate    DateTime?
  endDate      DateTime?
  isCurrent    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// TASKS & SUBMISSIONS
// ============================================================================

model Task {
  id                    String           @id @default(cuid())
  title                 String
  description           String?
  createdBy             User             @relation("TaskCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  createdByUserId       String
  assignedGroupType     GroupType        @default(ALL)
  assignedGroup         String?          // sector/club/department/committee ID
  targetUserIds         String[]         // explicit list of target user IDs
  taskType              TaskType
  mandatory             Boolean          @default(false)
  pointsPositive        Int              @default(0)
  pointsNegative        Int              @default(0)
  credit                Int              @default(0)  // APC credit awarded on task completion (MASTER only)
  startDate             DateTime
  endDate               DateTime
  attachments           String[]
  submissions           TaskSubmission[]
  pointsHistory         PointsHistory[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([createdByUserId])
  @@index([endDate])
  @@index([taskType])
}

enum GroupType {
  SECTOR
  CLUB
  DEPARTMENT
  COMMITTEE
  ALL
}

enum TaskType {
  YESNO
  COMMENT
  IMAGE
  DONATION
}

model TaskSubmission {
  id                    String           @id @default(cuid())
  task                  Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId                String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  submissionData        String?          // JSON for various submission types
  submissionFiles       String[]
  status                SubmissionStatus @default(PENDING)
  approvedBy            User?            @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedByUserId      String?
  approvedAt            DateTime?
  submittedAt           DateTime         @default(now())
  
  @@unique([taskId, userId])
  @@index([status])
  @@index([userId])
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// DONATIONS
// ============================================================================

model DonationCampaign {
  id                    String           @id @default(cuid())
  title                 String
  purpose               String?
  amountTarget          Float?
  bkashNumber           String?
  nagadNumber           String?
  expiryDate            DateTime
  status                CampaignStatus   @default(ACTIVE)
  pointsPerDonation     Int              @default(0)
  mandatory             Boolean          @default(false)
  pointsToDeduct        Int?
  isPublic              Boolean          @default(false)
  donations             Donation[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([status])
  @@index([expiryDate])
}

enum CampaignStatus {
  ACTIVE
  CLOSED
  EXPIRED
}

model Donation {
  id                    String           @id @default(cuid())
  campaign              DonationCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignId            String?
  user                  User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId                String?
  amount                Float
  trxId                 String
  paymentMethod         String           // bkash, nagad, visa, mastercard
  proofUrl              String?
  status                DonationStatus   @default(PENDING)
  approvedBy            User?            @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedByUserId      String?
  approvedAt            DateTime?
  pointsHistory         PointsHistory[]
  donatedAt             DateTime         @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([campaignId])
}

enum DonationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// INITIAL PAYMENT (30 BDT APPLICATION)
// ============================================================================

model InitialPayment {
  id                    String           @id @default(cuid())
  user                  User             @relation("InitialPaymentOwner", fields: [userId], references: [id], onDelete: Cascade)
  userId                String           @unique
  amount                Float            @default(30)
  trxId                 String
  reference             String?
  paymentMethod         String           // bkash, nagad, visa, mastercard
  senderNumber          String
  paymentDate           DateTime
  paymentTime           String?
  proofUrl              String?
  status                PaymentStatus    @default(PENDING)
  verifiedAt            DateTime?
  approvedById          String?
  approvedBy            User?            @relation("InitialPaymentApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  caReference           CAReference?     @relation(fields: [caReferenceId], references: [id], onDelete: SetNull)
  caReferenceId         String?
  // Referrer can be a Campus Ambassador (via caReferenceId) or an official Volunteer
  referrerType          String?          // 'CA' | 'VOLUNTEER'
  referrerUserId        String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([status])
  @@index([caReferenceId])
  @@index([referrerUserId])
}

model FinalPayment {
  id                    String           @id @default(cuid())
  user                  User             @relation("FinalPaymentOwner", fields: [userId], references: [id], onDelete: Cascade)
  userId                String           @unique
  amount                Float            @default(170)
  trxId                 String
  paymentMethod         String           // bkash, nagad, visa, mastercard
  senderNumber          String
  paymentDate           DateTime
  paymentTime           String?
  proofUrl              String?
  status                PaymentStatus    @default(PENDING)
  verifiedAt            DateTime?
  approvedById          String?
  approvedBy            User?            @relation("FinalPaymentApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([status])
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

// ============================================================================
// SOCIAL FEATURES
// ============================================================================

model Post {
  id                    String           @id @default(cuid())
  author                User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId              String
  content               String           @db.VarChar(2000)
  postType              PostType         @default(TEXT)
  metadata              String?          // JSON for gallery, event data
  isDeleted             Boolean          @default(false)
  comments              PostComment[]
  reactions             PostReaction[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([authorId])
  @@index([createdAt])
  @@index([isDeleted])
}

enum PostType {
  TEXT
  GALLERY
  EVENT
}

model PostReaction {
  id                    String           @id @default(cuid())
  post                  Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId                String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  type                  ReactionType     @default(LOVE)
  createdAt             DateTime         @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

enum ReactionType {
  LOVE
}

model PostComment {
  id                    String           @id @default(cuid())
  post                  Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId                String
  author                User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId              String
  content               String           @db.VarChar(1000)
  parentComment         PostComment?     @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  parentCommentId       String?
  replies               PostComment[]    @relation("CommentReplies")
  reactions             CommentReaction[]
  isDeleted             Boolean          @default(false)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
  @@index([createdAt])
}

model CommentReaction {
  id                    String           @id @default(cuid())
  comment               PostComment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId             String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  type                  ReactionType     @default(LOVE)
  createdAt             DateTime         @default(now())
  
  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Follow {
  id                    String           @id @default(cuid())
  follower              User             @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followerId            String
  following             User             @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  followingId           String
  createdAt             DateTime         @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model FriendRequest {
  id                    String           @id @default(cuid())
  sender                User             @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId              String
  receiver              User             @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  receiverId            String
  status                FriendRequestStatus @default(PENDING)
  createdAt             DateTime         @default(now())
  
  @@unique([senderId, receiverId])
  @@index([status])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model FriendList {
  id                    String           @id @default(cuid())
  user                  User             @relation("User", fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  friend                User             @relation("Friend", fields: [friendId], references: [id], onDelete: Cascade)
  friendId              String
  createdAt             DateTime         @default(now())
  
  @@unique([userId, friendId])
}

model Conversation {
  id                    String           @id @default(cuid())
  messages              Message[]
  lastMessageAt         DateTime?
  createdAt             DateTime         @default(now())
}

model Message {
  id                    String           @id @default(cuid())
  conversation          Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId        String
  fromUser              User             @relation("FromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId            String
  toUser                User             @relation("ToUser", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId              String
  body                  String
  readAt                DateTime?
  createdAt             DateTime         @default(now())
  
  @@index([conversationId])
  @@index([fromUserId])
  @@index([toUserId])
}

// ============================================================================
// SECTORS, DEPARTMENTS & CLUBS
// ============================================================================

model Sector {
  id                    String           @id @default(cuid())
  name                  String           @unique
  description           String?
  imageUrl              String?
  isOpen                Boolean          @default(true)
  committees            Committee[]
  createdAt             DateTime         @default(now())
}

model Department {
  id                    String           @id @default(cuid())
  name                  String           @unique
  description           String?
  responsibility        String?
  imageUrl              String?
  committees            Committee[]
  createdAt             DateTime         @default(now())
}

model Club {
  id                    String           @id @default(cuid())
  name                  String           @unique
  description           String?
  imageUrl              String?
  isOpen                Boolean          @default(true)
  committees            Committee[]
  createdAt             DateTime         @default(now())
}

model Service {
  id                    String           @id @default(cuid())
  name                  String
  code                  String?          // optional short code like VNSC (unique)
  instituteId           String?
  institute             Institute?       @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  auto                  Boolean          @default(false)
  isGlobal              Boolean          @default(false)
  description           String?
  createdById           String?          // HR/Master/Admin who created
  createdBy             User?            @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt             DateTime         @default(now())
  volunteerProfiles     VolunteerProfile[]

  @@index([name])
  @@index([instituteId])
  @@unique([name, instituteId])
  @@unique([code])
}

// ============================================================================
// NOTIFICATIONS & AUDIT
// ============================================================================

model Leave {
  id                    String           @id @default(cuid())
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  startDate             DateTime
  endDate               DateTime
  reason                String
  leaveType             LeaveType        @default(CASUAL)
  status                LeaveStatus      @default(PENDING)
  feedback              String?          // HR feedback/comment visible to volunteer
  reviewedBy            User?            @relation("LeaveReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedById          String?
  reviewedAt            DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

enum LeaveType {
  CASUAL
  SICK
  EMERGENCY
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  DECLINED
  REJECTED
}

model InterviewSlot {
  id                    String           @id @default(cuid())
  startTime             DateTime
  endTime               DateTime
  meetLink              String
  capacity              Int              @default(20)
  filledCount           Int              @default(0)
  createdBy             String           // HR user ID
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  applications          Application[]
  
  @@index([startTime])
  @@index([createdBy])
}

model JobPost {
  id                    String           @id @default(cuid())
  title                 String
  description           String
  requirements          String?
  isPublic              Boolean          @default(false)
  targetGroup           String?          // sector/club/department ID if private
  deadline              DateTime?
  status                JobPostStatus    @default(OPEN)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([status])
  @@index([isPublic])
}

enum JobPostStatus {
  OPEN
  CLOSED
}

model Notification {
  id                    String           @id @default(cuid())
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  broadcast             Boolean          @default(false)
  type                  NotificationType
  title                 String
  message               String?
  link                  String?          // Optional link to navigate to
  read                  Boolean          @default(false)
  createdAt             DateTime         @default(now())
  broadcastReads        BroadcastRead[]
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model BroadcastRead {
  id             String       @id @default(cuid())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  readAt         DateTime     @default(now())

  @@unique([notificationId, userId])
  @@index([userId])
  @@index([notificationId])
}

enum NotificationType {
  // Application & Payment
  INTERVIEW_PASSED
  INTERVIEW_REJECTED
  FINAL_PAYMENT_ACCEPTED
  FINAL_PAYMENT_REJECTED
  INITIAL_PAYMENT_ACCEPTED
  INITIAL_PAYMENT_REJECTED
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  
  // Tasks
  NEW_TASK
  TASK_APPROVED
  TASK_REJECTED
  
  // Events & Donations
  NEW_EVENT
  DONATION_REQUIRED
  
  // Social
  RANK_UPDATE
  FRIEND_REQUEST
  POST_REACTION
  POST_COMMENT
  COMMENT_REPLY
  NEW_FOLLOWER
  
  // General
  SYSTEM_ANNOUNCEMENT
  APPLICATION_UPDATE

  // Org membership
  ORG_JOIN_APPROVED
  ORG_JOIN_REJECTED

  // APC Credits
  APC_PAYOUT_REQUESTED
  APC_PAYOUT_COMPLETED
  APC_PAYOUT_REJECTED

  // Leave
  LEAVE_APPROVED
  LEAVE_DECLINED
  LEAVE_SUBMITTED

  // Mentions
  MENTION

  // Legacy (retained for existing DB rows — no longer issued by new code)
  COIN_ENDORSED
  COIN_ENDORSEMENT_REJECTED
}

model AuditLog {
  id                    String           @id @default(cuid())
  actor                 User             @relation("ActorUser", fields: [actorUserId], references: [id], onDelete: Cascade)
  actorUserId           String
  action                String
  meta                  String?          // JSON for additional info
  affectedVolunteerId   String?          // volunteer ID affected by this action (if any)
  points                Int?             // points change associated with this action (if any)
  createdAt             DateTime         @default(now())
  
  @@index([actorUserId])
  @@index([createdAt])
}

// ============================================================================
// CAMPUS AMBASSADOR REFERENCES
// ============================================================================

model CAReference {
  id                    String           @id @default(cuid())
  groupName             String
  caCode                String           @unique
  teamLeader            String
  initialPayments       InitialPayment[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([caCode])
  @@index([teamLeader])
}

// ============================================================================
// APC (ASADIAN PERFORMANCE CREDIT) PAYOUT SYSTEM
// ============================================================================

// Eligibility rule: 10,000 credits = 2,000 BDT; each additional 5,000 = 1,000 BDT
// Payout is discretionary – approved by admin; deduction only after "Paid" confirmation.

model CreditWithdrawal {
  id                    String           @id @default(cuid())
  user                  User             @relation("UserWithdrawals", fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  credits               Int              @map("coins")  // Credits to be deducted on approval
  bdtAmount             Float            @map("takaAmount")  // Calculated BDT (auto from eligibility rule)
  bkashNumber           String?          @map("accountNumber")  // User's bKash number
  paymentMethod         String?          // bkash, nagad, bank (kept for admin flexibility)
  status                WithdrawalStatus @default(PENDING)
  termsAccepted         Boolean          @default(false)  // User accepted APC T&C at time of request
  processedBy           User?            @relation("ProcessedBy", fields: [processedById], references: [id], onDelete: SetNull)
  processedById         String?
  processedAt           DateTime?
  notes                 String?          // Admin notes
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@map("CoinWithdrawal")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum WithdrawalStatus {
  PENDING
  COMPLETED
  REJECTED
}

// ============================================================================
// ORG JOIN REQUESTS (sector / club membership)
// ============================================================================

model OrgJoinRequest {
  id             String            @id @default(cuid())
  user           User              @relation("UserOrgJoinRequests", fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  type           OrgJoinType
  entityId       String            // sector or club ID
  entityName     String?           // denormalised for display
  status         JoinRequestStatus @default(PENDING)
  notes          String?           // admin notes
  processedBy    User?             @relation("ProcessedOrgJoinRequests", fields: [processedById], references: [id], onDelete: SetNull)
  processedById  String?
  processedAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([userId, type, entityId])
  @@index([userId])
  @@index([status])
  @@index([type])
}

enum OrgJoinType {
  SECTOR
  CLUB
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
